#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "üîç Checking for secrets in staged files..."

# Patterns that indicate secrets
SECRET_PATTERNS=(
    "sk-[a-zA-Z0-9]{48}"  # OpenAI API keys
    "sk_live_[0-9a-zA-Z]{99}"  # Stripe live keys
    "sk_test_[0-9a-zA-Z]{99}"  # Stripe test keys
    "pk_live_[0-9a-zA-Z]{99}"  # Stripe publishable live keys
    "pk_test_[0-9a-zA-Z]{99}"  # Stripe publishable test keys
    "whsec_[0-9a-zA-Z]{32}"  # Stripe webhook secrets
    "GOCSPX-[a-zA-Z0-9_-]{28}"  # Google OAuth client secrets
    "npg_[a-zA-Z0-9]{20}"  # Neon DB passwords
    "postgresql://[^:]+:[^@]+@"  # PostgreSQL connection strings
    "redis://[^:]+:[^@]+@"  # Redis connection strings
    "A[A-Z0-9]{34,}"  # Upstash Redis tokens
    "[0-9a-f]{64}"  # Generic 64-char hex secrets
)

# Check if any .env files are being committed
STAGED_ENV_FILES=$(git diff --cached --name-only | grep -E '\.env$|\.env\.local$|\.env\.production$')

if [ -n "$STAGED_ENV_FILES" ]; then
    echo -e "${RED}‚ùå ERROR: Attempting to commit .env files!${NC}"
    echo -e "${YELLOW}Found staged .env files:${NC}"
    echo "$STAGED_ENV_FILES"
    echo -e "${RED}NEVER commit .env files with real secrets!${NC}"
    echo -e "To fix: git reset HEAD <file>"
    exit 1
fi

# Check all staged files for secret patterns
STAGED_FILES=$(git diff --cached --name-only)

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -qE "$pattern" "$file"; then
                echo -e "${RED}‚ùå ERROR: Potential secret found in $file${NC}"
                echo -e "${YELLOW}Pattern matched: $pattern${NC}"
                echo -e "${RED}Please remove secrets before committing!${NC}"
                exit 1
            fi
        done
    fi
done

echo "‚úÖ No secrets detected in staged files"
exit 0
